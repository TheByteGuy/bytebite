<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dining Hall Menu Viewer</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 40px;
      background: #f9f9fb;
      color: #333;
    }
    h1 {
      color: #2c3e50;
    }
    select, button {
      padding: 10px 14px;
      font-size: 16px;
      margin-right: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      background: #3498db;
      color: white;
      border: none;
      cursor: pointer;
      transition: 0.3s;
    }
    button:hover {
      background: #2980b9;
    }
    #output {
      margin-top: 30px;
    }
    .meal-section {
      margin-bottom: 40px;
    }
    .meal-title {
      font-size: 1.5em;
      color: #2c3e50;
      border-bottom: 2px solid #3498db;
      padding-bottom: 8px;
      margin-bottom: 20px;
    }
    .group-title {
      font-size: 1.2em;
      color: #16a085;
      margin: 20px 0 10px;
      font-weight: bold;
    }
    .menu-card {
      background: white;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }
    .menu-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .item-name {
      font-weight: bold;
      font-size: 1.1em;
      color: #2c3e50;
      margin-bottom: 6px;
    }
    .item-meal {
      font-size: 0.9em;
      color: #34495e;
      margin-bottom: 6px;
      font-style: italic;
    }
    .item-desc {
      font-size: 0.9em;
      color: #7f8c8d;
      margin-bottom: 10px;
    }
    .nutrition-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 10px;
      font-size: 0.85em;
      margin-bottom: 10px;
    }
    .nutrient {
      background: #ecf0f1;
      padding: 6px 10px;
      border-radius: 6px;
      text-align: center;
    }
    .nutrient strong {
      display: block;
      color: #2c3e50;
    }
    .tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }
    .tag {
      font-size: 0.75em;
      padding: 4px 8px;
      border-radius: 12px;
      font-weight: bold;
    }
    .vegan { background: #27ae60; color: white; }
    .vegetarian { background: #2ecc71; color: white; }
    .plant-based { background: #1abc9c; color: white; }
    .mindful { background: #3498db; color: white; }
    .allergen { background: #e74c3c; color: white; }
    .no-data {
      color: #95a5a6;
      font-style: italic;
    }
    .error {
      color: #e74c3c;
      background: #fdf2f2;
      padding: 10px;
      border-radius: 6px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>Dining Hall Menu Lookup</h1>

  <label for="dhSelect">Choose Dining Hall:</label>
  <select id="dhSelect"></select>
  <br><br>
  <button id="fetchBtn">Get Menu</button>

  <div id="output">Menu will appear here...</div>

  <script>
    // Hardcoded API Key
    const API_KEY = "68717828-b754-420d-9488-4c37cb7d7ef7";

    // Local JSON containing name, location_id, and menu_id
    const diningData = [
      { name: "BARH", location_id: "76929003", menu_id: "153626" },
      { name: "Commons", location_id: "76929001", menu_id: "153148" },
      { name: "Russell Sage", location_id: "76929002", menu_id: "153157" },
      { name: "Blitman", location_id: "76929015", menu_id: "153702" }
    ];

    // Populate dropdown
    const select = document.getElementById("dhSelect");
    diningData.forEach(item => {
      const opt = document.createElement("option");
      opt.value = item.menu_id;
      opt.textContent = item.name;
      select.appendChild(opt);
    });

    // Helper: parse nutrient with fallback
    function parseNutrient(value, unit = '') {
      if (!value || value === "" || value === "0" || value === "0mg" || value === "0mcg") return `<span class="no-data">â€”</span>`;
      if (typeof value === 'string' && value.includes('g')) return `<strong>${value}</strong>`;
      return `<strong>${value}${unit}</strong>`;
    }

    // Helper: get allergen names
    function getAllergens(allergens) {
      if (!allergens || allergens.length === 0) return '';
      return allergens.map(a => a.name).join(', ');
    }

    // Helper: diet badges
    function getDietBadges(item) {
      const badges = [];
      if (item.isVegan) badges.push('<span class="tag vegan">Vegan</span>');
      if (item.isVegetarian) badges.push('<span class="tag vegetarian">Vegetarian</span>');
      if (item.isPlantBased) badges.push('<span class="tag plant-based">Plant-Based</span>');
      if (item.isMindful) badges.push('<span class="tag mindful">Mindful</span>');
      return badges.join('');
    }

    // Render menu
    function renderMenu(data) {
      const output = document.getElementById("output");
      output.innerHTML = '';

      let meals = Array.isArray(data) ? data : (data.meals || []);

      if (meals.length === 0) {
        const p = document.createElement('p');
        p.textContent = 'No menu data available for today.';
        p.className = 'error';
        output.appendChild(p);
        return;
      }

      meals.forEach(meal => {
        const mealDiv = document.createElement('div');
        mealDiv.className = 'meal-section';

        const mealTitle = document.createElement('div');
        mealTitle.className = 'meal-title';
        mealTitle.textContent = meal.name;
        mealDiv.appendChild(mealTitle);

        meal.groups.forEach(group => {
          const groupTitle = document.createElement('div');
          groupTitle.className = 'group-title';
          groupTitle.textContent = group.name;
          mealDiv.appendChild(groupTitle);

          group.items.forEach(item => {
            const card = document.createElement('div');
            card.className = 'menu-card';

            // Name & Meal Type
            const name = document.createElement('div');
            name.className = 'item-name';
            name.textContent = item.formalName;
            card.appendChild(name);

            const mealType = document.createElement('div');
            mealType.className = 'item-meal';
            mealType.textContent = `Meal: ${item.meal}`;
            card.appendChild(mealType);

            if (item.description && item.description !== item.formalName) {
              const desc = document.createElement('div');
              desc.className = 'item-desc';
              desc.textContent = item.description;
              card.appendChild(desc);
            }

            // Nutrition Grid
            const grid = document.createElement('div');
            grid.className = 'nutrition-grid';

            const nutrients = [
              { label: 'Calories', value: item.calories },
              { label: 'Total Fat', value: item.fat, unit: 'g' },
              { label: 'Sat. Fat', value: item.saturatedFat },
              { label: 'Carbs', value: item.carbohydrates, unit: 'g' },
              { label: 'Fiber', value: item.dietaryFiber, unit: 'g' },
              { label: 'Protein', value: item.protein, unit: 'g' },
              { label: 'Sugar', value: item.sugar, unit: 'g' },
              { label: 'Sodium', value: item.sodium },
              { label: 'Iron', value: item.iron },
              { label: 'Calcium', value: item.calcium },
              { label: 'Potassium', value: item.potassium },
              { label: 'Vitamin D', value: item.vitaminD }
            ];

            nutrients.forEach(n => {
              const div = document.createElement('div');
              div.className = 'nutrient';
              const unit = n.unit || '';
              div.innerHTML = `${n.label}<br>${parseNutrient(n.value, unit)}`;
              grid.appendChild(div);
            });

            card.appendChild(grid);

            // Tags: Diet + Allergens
            const tags = document.createElement('div');
            tags.className = 'tags';
            tags.innerHTML = getDietBadges(item);

            const allergenText = getAllergens(item.allergens);
            if (allergenText) {
              tags.innerHTML += `<span class="tag allergen">Allergens: ${allergenText}</span>`;
            }

            card.appendChild(tags);
            mealDiv.appendChild(card);
          });
        });

        output.appendChild(mealDiv);
      });
    }

    document.getElementById("fetchBtn").addEventListener("click", async () => {
      const chosen = diningData.find(d => d.menu_id === select.value);
      const url = `https://api-prd.sodexomyway.net/v0.2/data/menu/${chosen.location_id}/${chosen.menu_id}?date=2025-11-21`;

      document.getElementById("output").textContent = "Loading...";

      try {
        const resp = await fetch(url, {
          headers: {
            "accept": "application/json",
            "content-type": "application/json",
            "api-key": API_KEY
          }
        });
        if (!resp.ok) {
          throw new Error(`HTTP error! status: ${resp.status}`);
        }
        const data = await resp.json();
        renderMenu(data);
      } catch (err) {
        document.getElementById("output").innerHTML = `<div class="error">Error: ${err}</div>`;
      }
    });
  </script>
</body>
</html>